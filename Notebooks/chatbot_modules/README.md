# Модульный чат-бот с RAG и голосовым вводом

Модульный чат-бот с использованием Retrieval-Augmented Generation (RAG) для ответов на вопросы об уходе за автомобилем. Поддерживает как текстовый, так и голосовой ввод.

## Особенности

- Комбинированный поиск по базе знаний (векторный + BM25)
- Переранжирование результатов с помощью CrossEncoder
- Интеграция с LangChain для создания цепочки обработки запросов
- Кэширование ответов для повышения производительности
- Хранение истории диалогов в SQLite базе данных
- Возможность просмотра и очистки истории диалога
- Поиск в интернете, если информации в базе знаний недостаточно
- Ограничение количества релевантных источников до трех
- Ограничение количества попыток поиска в интернете до трех
- Указание в ответе, если информация получена из интернета
- Голосовой ввод с использованием различных распознавателей речи
- Возможность переключения между текстовым и голосовым вводом во время работы

## Структура проекта

- `retriever.py` - модуль для поиска документов в базе знаний
- `chat.py` - модуль для управления диалогом с использованием LangChain
- `utils.py` - вспомогательные функции (кэширование, история диалога, поиск в интернете)
- `db.py` - модуль для работы с SQLite базой данных для хранения истории диалогов
- `speech_to_text.py` - модуль для распознавания речи с использованием различных API
- `main.py` - основной файл для запуска чат-бота
- `example_usage.ipynb` - пример использования чат-бота в Jupyter Notebook
- `requirements.txt` - список зависимостей для установки

## Требования

- Python 3.8+
- LangChain
- ChromaDB
- HuggingFace Transformers
- OpenRouter API ключ (для доступа к языковым моделям)
- Serper API ключ (опционально, для поиска в интернете)
- SpeechRecognition и PyAudio (для голосового ввода)
- Whisper или PocketSphinx (опционально, для локального распознавания речи)

## Установка

1. Клонировать репозиторий
2. Установить зависимости:
```bash
pip install -r requirements.txt
```
3. Для голосового ввода установить дополнительные зависимости:
```bash
# Для базового распознавания речи через Google API
pip install SpeechRecognition PyAudio

# Для локального распознавания речи (опционально)
pip install openai-whisper  # Для Whisper
pip install pocketsphinx    # Для CMU Sphinx
```
4. Создать файл `.env` в корневой директории проекта со следующими переменными:
```
OPENROUTER_API_KEY=ваш_ключ_openrouter
SERPER_API_KEY=ваш_ключ_serper (опционально)
OPENAI_API_KEY=ваш_ключ_openai (опционально, для Whisper API)
```

## Использование

### Запуск из командной строки

```bash
# Запуск с текстовым вводом
python main.py --model anthropic/claude-3.5-haiku --temperature 0.5 --max-tokens 2048 --use-web-search

# Запуск с голосовым вводом (Google Speech Recognition)
python main.py --use-voice --speech-recognizer google --speech-language ru-RU

# Запуск с локальным распознаванием речи (Whisper)
python main.py --use-voice --speech-recognizer whisper --speech-language ru

# Запуск с сохранением истории диалогов (включено по умолчанию)
python main.py --db-path ./chat_history.db

# Запуск без сохранения истории диалогов
python main.py --no-history

# Запуск с настройками реранкера
python main.py --similarity-top-k 15 --bm25-top-k 15 --reranker-top-k 7

# Запуск без реранкера
python main.py --no-reranker

# Запуск с другой моделью реранкера
python main.py --reranker-model cross-encoder/ms-marco-MiniLM-L-6-v2
```

### Запуск Streamlit-приложения

Для запуска веб-интерфейса на базе Streamlit выполните:

```bash
streamlit run app.py
```

Это запустит веб-сервер, доступный по адресу http://localhost:8501

Особенности Streamlit-приложения:
- Удобный веб-интерфейс
- Поддержка голосового ввода через микрофон
- Отображение истории диалога
- Возможность очистки истории
- Отображение источников информации

Параметры:
- `--model` - название модели в OpenRouter (по умолчанию: anthropic/claude-3.5-haiku)
- `--temperature` - температура генерации (по умолчанию: 0.5)
- `--max-tokens` - максимальное количество токенов в ответе (по умолчанию: 2048)
- `--use-web-search` - использовать поиск в интернете (по умолчанию: True)
- `--cache-file` - путь к файлу для сохранения кэша (по умолчанию: ./response_cache.json)
- `--db-path` - путь к файлу базы данных SQLite для хранения истории диалогов (по умолчанию: ./chat_history.db)
- `--no-history` - отключить сохранение истории диалогов (по умолчанию: история сохраняется)
- `--use-voice` - использовать голосовой ввод (по умолчанию: True)
- `--speech-recognizer` - тип распознавателя речи: google, whisper, whisper_api, sphinx (по умолчанию: google)
- `--speech-language` - язык распознавания речи (по умолчанию: ru-RU)

Параметры для ретривера и реранкера:
- `--similarity-top-k` - количество документов для поиска по векторной близости (по умолчанию: 10)
- `--bm25-top-k` - количество документов для поиска по BM25 (по умолчанию: 10)
- `--similarity-weight` - вес для результатов векторного поиска (по умолчанию: 0.5)
- `--bm25-weight` - вес для результатов BM25 поиска (по умолчанию: 0.5)
- `--no-reranker` - отключить использование реранкера (по умолчанию: реранкер включен)
- `--reranker-model` - название модели для реранкера (по умолчанию: DiTy/cross-encoder-russian-msmarco)
- `--reranker-top-k` - количество документов после переранжирования (по умолчанию: 5)

### Использование голосового ввода

После запуска чат-бота с параметром `--use-voice`, вы можете:
1. Говорить в микрофон, когда появится сообщение "Говорите сейчас..."
2. Переключаться между голосовым и текстовым вводом, введя команду 'г'
3. Просматривать историю диалога, введя команду 'и'
4. Очищать историю диалога, введя команду 'о'
5. Выйти из чата, введя команду 'х'

Распознанный текст будет отображаться с указанием уровня уверенности распознавания.

### Работа с историей диалогов

Чат-бот автоматически сохраняет историю диалогов в SQLite базе данных. Для каждого пользователя создается уникальный идентификатор, который используется для хранения его сообщений. При повторном запуске чат-бота с тем же идентификатором пользователя, история диалога будет загружена из базы данных.

Команды для работы с историей диалога:
- 'и' - показать историю диалога
- 'о' - очистить историю диалога

### Использование в Jupyter Notebook

См. пример в файле `example_usage.ipynb`.

## Расширение функциональности

Проект имеет модульную структуру, что позволяет легко расширять его функциональность:

- Добавление новых источников данных
- Изменение моделей для эмбеддингов или генерации ответов
- Добавление новых инструментов для поиска информации
- Изменение промптов для генерации ответов